name: Release Publisher

on:
  push:
    tags:
      - '*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Package üõéÔ∏è
        uses: actions/checkout@v2
      - name: Compose Release
        id: release_body
        run: |
          git fetch --all --tags --force
          most_recent_version=$(git tag --sort v:refname | tail -n 1)
          last_version=$(git tag --sort v:refname | tail -n 2 | head -n 1)
          num_commits=$(git rev-list --count $last_version..$most_recent_version)
          echo "$num_commits since $last_version"
          git_log=$(git log -n $num_commits --pretty="format:* %s %n")
          linked_log=$(echo "Release Notes:\n\n$git_log")
          echo "Raw Log: $linked_log"
          linked_log="${linked_log//#\([0-9]*\[#\1](https:\/\/github.com\/rogebrd\/dropbox-oauth-popup\/pull\/\1))}"
          echo "Replaced Log: $linked_log"
          linked_log="${linked_log//'%'/'%25'}"
          linked_log="${linked_log//$'\n'/'%0A'}"
          linked_log="${linked_log//$'\r'/'%0D'}"
          echo "::set-output name=release_body::$linked_log"
      - name: Publish Release 
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
        with:
          tag_name: ${{ github.ref }}
          release_name: ${{ github.ref }}
          body: ${{ steps.release_body.outputs.release_body }}
          draft: false
          prerelease: false